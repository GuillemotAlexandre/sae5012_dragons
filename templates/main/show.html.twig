{% extends 'base.html.twig' %}

{% block title %}{{ article.title }}{% endblock %}

{# Imports pour les graphiques (Chart.js) #}
{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
{% endblock %}

{% block body %}
<div class="max-w-4xl mx-auto py-10">
    
    <a href="{{ path('app_forum') }}" class="inline-flex items-center text-slate-400 hover:text-white mb-6 transition">
        ‚Üê Retour au forum
    </a>

    {# üëá √âTAPE 3 : LECTEUR AUDIO üëá #}
    {% if article.music %}
        <div class="bg-slate-800 border border-slate-600 p-4 rounded-lg mb-6 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üéµ</span>
                <div>
                    <p class="text-white font-bold text-sm">Ambiance Sonore</p>
                    <p class="text-slate-400 text-xs">Profitez de la lecture en musique</p>
                </div>
            </div>
            {# Le lecteur audio HTML5 standard #}
            <audio controls autoplay controlsList="nodownload" class="h-10 w-64 rounded-full bg-slate-200">
                {# asset() cherche dans le dossier public/ #}
                <source src="{{ asset('musique/' ~ article.music) }}" type="audio/mpeg">
                Votre navigateur ne supporte pas l'√©l√©ment audio.
            </audio>
        </div>
    {% endif %}
    {# üëÜ FIN LECTEUR AUDIO üëÜ #}

    {# --- 1. EN-T√äTE ARTICLE + NOTATION --- #}
    <div class="bg-slate-800 p-8 rounded-t-lg border border-slate-700 border-b-0 relative">
        <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-orange-400 mb-4 break-words">
            {{ article.title }}
        </h1>
        
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-2 text-sm text-slate-400">
                <span class="bg-slate-700 px-2 py-1 rounded text-white font-bold">
                    {% if article.author %}{{ article.author.pseudo }}{% else %}Anonyme{% endif %}
                </span>
                <span>le {{ article.createdAt|date('d/m/Y √† H:i') }}</span>
            </div>

            {# ‚≠ê SYST√àME DE NOTATION ‚≠ê #}
            <div class="bg-slate-900 px-4 py-2 rounded-full border border-slate-700 flex items-center gap-3">
                <div class="text-yellow-400 font-bold text-lg">
                    {% set avg = article.averageRating %}
                    {% if avg %}
                        {{ avg }} <span class="text-xs text-slate-500">/ 5</span>
                    {% else %}
                        <span class="text-xs text-slate-500">Pas de note</span>
                    {% endif %}
                </div>
                
                {% if app.user %}
                <div class="flex gap-1">
                    {% for i in 1..5 %}
                        <a href="{{ path('app_article_rate', {id: article.id, score: i}) }}" 
                           class="text-xl transition hover:scale-125 {% if avg and i <= avg|round %}text-yellow-400{% else %}text-slate-600 hover:text-yellow-200{% endif %}"
                           title="Donner {{ i }} √©toiles">
                           ‚òÖ
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# --- 2. CONTENU DE L'ARTICLE (Blocs) --- #}
    <div class="bg-slate-900 border border-slate-700 p-8 rounded-b-lg min-h-[300px] mb-12">
        
        {# R√©sum√© (Intro) #}
        <div class="text-xl text-slate-400 italic mb-8 border-l-4 border-red-500 pl-4 break-words">
            {{ article.summary|nl2br }}
        </div>
        
        <hr class="border-slate-800 mb-8">
        
        {# Blocs Dynamiques #}
        <div class="space-y-6">
            {% for bloc in article.blocs %}
                
                {# TITRE H2 #}
                {% if bloc.type == 'title_h2' %}
                    <h2 class="text-2xl font-bold text-red-400 mt-8 mb-4 break-words">{{ bloc.content }}</h2>
                
                {# TEXTE #}
                {% elseif bloc.type == 'text' %}
                    {% if bloc.title %}<h3 class="text-lg font-semibold text-slate-500 mt-4">{{ bloc.title }}</h3>{% endif %}
                    <p class="text-slate-300 leading-relaxed text-lg text-justify break-words">{{ bloc.content|nl2br }}</p>
                
                {# IMAGE #}
                {% elseif bloc.type == 'image' %}
                    <figure class="my-6 bg-slate-800 p-2 rounded-lg border border-slate-700">
                        <img src="{{ bloc.content }}" alt="{{ bloc.title }}" class="rounded shadow-lg w-full object-cover max-h-[500px]">
                        {% if bloc.title %}
                            <figcaption class="text-center text-slate-500 text-sm mt-2 italic">{{ bloc.title }}</figcaption>
                        {% endif %}
                    </figure>
                
                {# VISUALISATION (GRAPHIQUE) #}
                {% elseif bloc.type == 'viz' %}
                    {% set parts = bloc.content|split('::') %}
                    {% set vizType = parts[0] %}
                    {% set csvPath = parts[1] %}

                    <div class="bg-slate-800 p-4 border border-slate-700 rounded-lg shadow-lg my-8">
                        {% if bloc.title %}
                            <h3 class="text-center text-xl font-bold text-white mb-4">{{ bloc.title }}</h3>
                        {% endif %}
                        <div class="relative h-[400px] w-full">
                            <canvas id="chart-{{ bloc.id }}"></canvas>
                        </div>
                        <div class="text-center mt-2">
                            <a href="{{ csvPath }}" class="text-xs text-slate-500 hover:text-red-400 underline" download>T√©l√©charger les donn√©es (CSV)</a>
                        </div>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const csvUrl = "{{ csvPath }}";
                            const chartId = "chart-{{ bloc.id }}";
                            const chartType = "{{ vizType }}";

                            Papa.parse(csvUrl, {
                                download: true,
                                header: false,
                                delimiter: ";",
                                skipEmptyLines: true,
                                complete: function(results) {
                                    const data = results.data;
                                    let labels = [];
                                    let values = [];
                                    
                                    data.forEach(row => {
                                        if(row.length >= 2) {
                                            let valStr = row[1].toString().replace(',', '.').trim();
                                            if(!isNaN(parseFloat(valStr))) {
                                                labels.push(row[0]);
                                                values.push(parseFloat(valStr));
                                            }
                                        }
                                    });

                                    const ctx = document.getElementById(chartId).getContext('2d');
                                    new Chart(ctx, {
                                        type: chartType,
                                        data: {
                                            labels: labels,
                                            datasets: [{
                                                label: 'Donn√©es',
                                                data: values,
                                                backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(168, 85, 247, 0.7)'],
                                                borderColor: 'rgba(255, 255, 255, 0.5)',
                                                borderWidth: 1
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: { legend: { labels: { color: 'white' } } },
                                            scales: {
                                                y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' }, beginAtZero: true },
                                                x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                                            }
                                        }
                                    });
                                }
                            });
                        });
                    </script>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    {# --- 3. SECTION COMMENTAIRES --- #}
    <div class="border-t border-slate-700 pt-10">
        <h3 class="text-2xl font-bold text-white mb-6">Discussions ({{ article.comments|length }})</h3>

        {% if app.user %}
            <div class="bg-slate-800 p-4 rounded mb-8 border border-slate-700">
                {{ form_start(commentForm) }}
                    {{ form_widget(commentForm.content) }}
                    <div class="flex justify-end mt-2">
                        {{ form_widget(commentForm.submit) }}
                    </div>
                {{ form_end(commentForm) }}
            </div>
        {% else %}
            <div class="bg-slate-800/50 p-4 rounded text-center text-slate-400 mb-8">
                <a href="{{ path('app_login') }}" class="text-red-400 font-bold">Connectez-vous</a> pour rejoindre le d√©bat.
            </div>
        {% endif %}

        {# MACRO RECURSIVE COMMENTAIRES #}
        {% macro display_comment(comment, article_id, level = 0) %}
            <div class="flex gap-3 mb-4 {% if level > 0 %}ml-8 border-l-2 border-slate-700 pl-4{% endif %}" id="comment-{{ comment.id }}">
                <div class="flex flex-col items-center gap-1 pt-1 min-w-[30px]">
                    <a href="{{ path('app_comment_vote', {id: comment.id, direction: 'up'}) }}" class="text-slate-500 hover:text-orange-500 transition font-bold text-lg leading-none">‚ñ≤</a>
                    <span class="font-bold text-sm {% if comment.score > 0 %}text-orange-400{% elseif comment.score < 0 %}text-blue-400{% else %}text-slate-400{% endif %}">
                        {{ comment.score }}
                    </span>
                    <a href="{{ path('app_comment_vote', {id: comment.id, direction: 'down'}) }}" class="text-slate-500 hover:text-blue-500 transition font-bold text-lg leading-none">‚ñº</a>
                </div>
                <div class="flex-1">
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="font-bold text-slate-200 text-sm">{{ comment.author.pseudo }}</span>
                        <span class="text-xs text-slate-500">{{ comment.createdAt|date('d/m H:i') }}</span>
                    </div>
                    <p class="text-slate-300 text-sm leading-relaxed mb-2 break-words">{{ comment.content }}</p>
                    {% if app.user %}
                    <button onclick="toggleReplyForm({{ comment.id }})" class="text-xs text-slate-500 font-bold hover:text-white flex items-center gap-1 mb-2">
                        <span>üí¨</span> R√©pondre
                    </button>
                    <div id="reply-form-{{ comment.id }}" class="hidden mt-2 mb-4 bg-slate-800 p-3 rounded border border-slate-600">
                        <form action="{{ path('app_article_show', {id: article_id}) }}" method="post">
                            <textarea name="comment[content]" rows="2" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm mb-2 focus:ring-1 focus:ring-red-500 outline-none" placeholder="Votre r√©ponse..."></textarea>
                            <input type="hidden" name="comment[parentid]" value="{{ comment.id }}">
                            <input type="hidden" name="comment[_token]" value="{{ csrf_token('comment') }}">
                            <div class="flex justify-end">
                                <button type="submit" class="bg-slate-700 hover:bg-slate-600 text-white text-xs px-3 py-1 rounded transition font-bold">Envoyer</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                    {% if comment.replies is not empty %}
                        <div class="mt-2">
                            {% for reply in comment.replies %}
                                {{ _self.display_comment(reply, article_id, level + 1) }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endmacro %}

        {% for comment in article.comments %}
            {% if comment.parent is null %}
                {{ _self.display_comment(comment, article.id) }}
            {% endif %}
        {% else %}
            <p class="text-slate-500 italic mt-8 text-center border-dashed border border-slate-700 p-4 rounded">
                Aucun commentaire pour le moment. Soyez le premier √† r√©agir !
            </p>
        {% endfor %}
    </div>
</div>

<script>
    function toggleReplyForm(id) {
        const form = document.getElementById('reply-form-' + id);
        form.classList.toggle('hidden');
    }
</script>
{% endblock %}