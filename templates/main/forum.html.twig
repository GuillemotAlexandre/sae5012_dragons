{% extends 'base.html.twig' %}

{% block title %}Le Forum des Chasseurs{% endblock %}

{% block body %}
<div class="max-w-4xl mx-auto">
    
    <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
        <div>
            <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-orange-400">
                Chroniques de Chasse
            </h2>
            <p class="text-slate-400 mt-1">Partagez vos récits et découvertes draconiques.</p>
        </div>
        <div class="text-sm text-slate-500">
            {{ articles|length }} parchemins trouvés
        </div>
    </div>

    {# MESSAGES FLASH #}
    {% for message in app.flashes('success') %}
        <div class="bg-green-500/10 border border-green-500 text-green-400 px-4 py-3 rounded mb-6 flex items-center gap-3">
            <span class="text-xl">✅</span>
            {{ message }}
        </div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="bg-red-500/10 border border-red-500 text-red-400 px-4 py-3 rounded mb-6 flex items-center gap-3">
            <span class="text-xl">⚠️</span>
            {{ message }}
        </div>
    {% endfor %}

    {# FORMULAIRE D'AJOUT #}
    {% if app.user %}
        <div class="bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700 mb-10">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span>✍️</span> Écrire une nouvelle chronique
            </h3>
            
            {{ form_start(form) }}
                {# Champs Titre et Résumé #}
                <div class="mb-4">
                    {{ form_label(form.title, null, {'label_attr': {'class': 'text-slate-300 block mb-1'}}) }}
                    {{ form_widget(form.title) }}
                    <div class="text-red-400 text-xs mt-1">{{ form_errors(form.title) }}</div>
                </div>

                <div class="mb-4">
                    {{ form_label(form.summary, null, {'label_attr': {'class': 'text-slate-300 block mb-1'}}) }}
                    {{ form_widget(form.summary) }}
                    <div class="text-red-400 text-xs mt-1">{{ form_errors(form.summary) }}</div>
                </div>

                {# --- SECTION BLOCS DYNAMIQUES --- #}
                <div class="mb-6 border-t border-slate-700 pt-4">
                    <h4 class="text-lg font-semibold text-red-400 mb-2">Contenu de l'article</h4>
                    
                    <div id="blocs-wrapper" 
                         data-prototype="{{ form_widget(form.blocs.vars.prototype)|e('html_attr') }}"
                         data-index="{{ form.blocs|length }}">
                        
                        {# Pour afficher les blocs s'il y en a déjà (ex: erreur de validation) #}
                        {% for blocField in form.blocs %}
                            <div class="bg-slate-900 p-4 rounded mb-2 border border-slate-600 relative bloc-item">
                                {{ form_widget(blocField) }}
                            </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-bloc-btn" 
                            class="text-sm bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded mt-2 transition flex items-center gap-2 border border-slate-600">
                        <span class="text-xl font-bold">+</span> Ajouter un bloc de contenu
                    </button>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white font-bold py-3 px-6 rounded transition flex justify-center items-center gap-2 mt-4 shadow-lg">
                    Publier le parchemin
                </button>
            {{ form_end(form) }}
        </div>

        {# SCRIPT JAVASCRIPT #}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const wrapper = document.querySelector('#blocs-wrapper');
                const addBtn = document.querySelector('#add-bloc-btn');

                // Fonction pour gérer l'affichage Texte vs Image
                function attachEvents(element) {
                    const select = element.querySelector('.js-type-selector');
                    const contentField = element.querySelector('.js-content-field'); // Textarea
                    const imageField = element.querySelector('.js-image-field');     // Input File
                    
                    // Sécurité si les classes n'existent pas
                    if (!select || !contentField || !imageField) return;

                    // Fonction interne pour basculer
                    const toggleFields = () => {
                        const val = select.value;
                        // On remonte au parent (div) pour cacher tout le champ (label inclus)
                        const contentContainer = contentField.closest('div'); 
                        const imageContainer = imageField.closest('div');

                        if (val === 'image') {
                            // Si Image : On cache le texte, on montre l'upload
                            if(contentContainer) contentContainer.classList.add('hidden');
                            if(imageContainer) imageContainer.classList.remove('hidden');
                            imageField.classList.remove('hidden'); // Sécurité
                        } else {
                            // Sinon : On montre le texte, on cache l'upload
                            if(contentContainer) contentContainer.classList.remove('hidden');
                            if(imageContainer) imageContainer.classList.add('hidden');
                        }
                    };

                    // Écouter le changement sur le selecteur (H2, Texte, Image...)
                    select.addEventListener('change', toggleFields);
                    
                    // Lancer une fois au démarrage pour initialiser l'état
                    toggleFields();
                }

                // Initialiser sur les blocs existants (s'il y en a)
                document.querySelectorAll('.bloc-item').forEach(attachEvents);
                
                // Gérer le clic sur "Ajouter un bloc"
                addBtn.addEventListener('click', function() {
                    const prototype = wrapper.dataset.prototype;
                    const index = wrapper.dataset.index;
                    // Remplacer __name__ par l'index unique
                    const newForm = prototype.replace(/__name__/g, index);
                    
                    const div = document.createElement('div');
                    div.innerHTML = newForm;
                    div.classList.add('bg-slate-900', 'p-4', 'rounded', 'mb-4', 'border', 'border-slate-600', 'mt-4', 'relative', 'bloc-item');
                    
                    // Bouton de suppression
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = "Supprimer";
                    removeBtn.type = "button";
                    removeBtn.classList.add('text-xs', 'text-red-400', 'hover:text-red-300', 'absolute', 'top-2', 'right-2');
                    removeBtn.onclick = function() { div.remove(); };
                    div.appendChild(removeBtn);

                    wrapper.appendChild(div);
                    wrapper.dataset.index = parseInt(index) + 1;

                    // Attacher les événements (toggle image/texte) au nouveau bloc
                    attachEvents(div);
                });
            });
        </script>

    {% else %}
        {# Affichage pour les visiteurs non connectés #}
        <div class="bg-slate-800/50 border border-dashed border-slate-600 p-6 rounded-lg text-center mb-10">
            <p class="text-slate-400 mb-3">Vous devez être membre de la guilde pour publier.</p>
            <a href="{{ path('app_login') }}" class="text-red-400 font-bold hover:underline">Se connecter</a>
            <span class="text-slate-600 mx-2">|</span>
            <a href="{{ path('app_register') }}" class="text-red-400 font-bold hover:underline">S'inscrire</a>
        </div>
    {% endif %}

    {# LISTE DES ARTICLES #}
    <div class="space-y-6">
        {% for article in articles %}
            <article class="bg-slate-800 p-6 rounded-lg hover:bg-slate-750 transition border-l-4 border-red-500 shadow-md">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold text-slate-100">{{ article.title }}</h3>
                    <span class="text-xs text-slate-500 bg-slate-900 px-2 py-1 rounded border border-slate-700">
                        {{ article.createdAt|date('d/m/Y H:i') }}
                    </span>
                </div>
                
                <p class="text-slate-400 mb-4 leading-relaxed break-all line-clamp-3">
                    {{ article.summary }}
                </p>

                <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-700/50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center text-xs font-bold text-white">
                            {% if article.author %}
                                {{ article.author.pseudo|first|upper }}
                            {% else %}
                                ?
                            {% endif %}
                        </div>
                        <span class="text-sm text-slate-300 font-medium">
                            {% if article.author %}
                                {{ article.author.pseudo }}
                            {% else %}
                                Anonyme
                            {% endif %}
                        </span>
                    </div>
                    
                    <a href="{{ path('app_article_show', {'id': article.id}) }}" class="text-sm text-red-400 hover:text-red-300 font-semibold transition">
                        Lire la suite →
                    </a>
                </div>
            </article>
        {% else %}
            <div class="text-center py-10">
                <p class="text-slate-500 text-lg">Les archives sont vides... Soyez le premier à écrire l'histoire !</p>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}